name: Release Polyglot Piranha
on:
  workflow_dispatch:
    inputs:
      isTestRelease:
        description: 'Should this be released on testpypi?'
        required: true
        default: true
        type: boolean
jobs:
  build_ubuntu:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build
      run: cargo build --release
      working-directory: polyglot/piranha
    - uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Build Wheel
      run: |
        pip install --upgrade maturin
        maturin build --release -o dist
      working-directory: polyglot/piranha
    - if: ${{  inputs.isTestRelease  }}
      name: Create TestPypi Release
      run: |
        pip install twine
        twine upload --repository testpypi --skip-existing -u ketkara -p ${{ secrets.PYPI_PASSWORD }} dist/*
      working-directory: polyglot/piranha
    - if: false == ${{  inputs.isTestRelease  }} 
      name: Create Pypi Release (with ubuntu-latest)
      run: |
        pip install twine
        twine upload --skip-existing -u ketkara -p ${{ secrets.PYPI_PASSWORD }} dist/*
      working-directory: polyglot/piranha
  
  build_mac_os:
    needs: build_ubuntu
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build
      run: cargo build --release
      working-directory: polyglot/piranha
    - uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Build Wheel
      run: |
        pip install --upgrade maturin
        maturin build --release -o dist
      working-directory: polyglot/piranha
    - name: Build Wheel - universal2
      env:
        DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
        SDKROOT: /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk
        MACOSX_DEPLOYMENT_TARGET: 10.9
      run: |
        rustup target add aarch64-apple-darwin
        pip install --upgrade maturin
        maturin build --release -o dist --universal2
      working-directory: polyglot/piranha
    - if: ${{  inputs.isTestRelease  }}
      name: Create TestPypi Release
      run: |
        pip install twine
        twine upload --repository testpypi --skip-existing -u ketkara -p ${{ secrets.PYPI_PASSWORD }} dist/*
      working-directory: polyglot/piranha
    - if: false == ${{  inputs.isTestRelease  }} 
      name: Pypi Release macos-latest
      run: |
        pip install twine
        twine upload --skip-existing -u ketkara -p ${{ secrets.PYPI_PASSWORD }} dist/*
      working-directory: polyglot/piranha


  build_mac_os11:
    needs: build_ubuntu
    runs-on: macos-11
    steps:
    - uses: actions/checkout@v2
    - name: Build
      run: cargo build --release
      working-directory: polyglot/piranha
    - uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Build Wheel
      run: |
        pip install --upgrade maturin
        maturin build --release -o dist
      working-directory: polyglot/piranha
    - if: ${{  inputs.isTestRelease  }}
      name: Create TestPypi Release
      run: |
        pip install twine
        twine upload --repository testpypi --skip-existing -u ketkara -p ${{ secrets.PYPI_PASSWORD }} dist/*
      working-directory: polyglot/piranha
    - if: false == ${{  inputs.isTestRelease  }} 
      name: Pypi Release for macos-11
      run: |
        pip install twine
        twine upload --skip-existing -u ketkara -p ${{ secrets.PYPI_PASSWORD }} dist/*
      working-directory: polyglot/piranha
